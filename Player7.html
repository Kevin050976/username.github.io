<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å½±éŸ³å°æ™‚æ’­æ”¾å™¨ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root { --bg: #1c1c1e; --card: #2c2c2e; --primary: #30d158; --text: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); box-sizing: border-box; }
        #wall-time { font-family: "Menlo", monospace; font-size: 48px; text-align: center; color: var(--primary); margin: 10px 0; font-weight: bold; }
        #media-container { width: 100%; margin-top: 15px; background: #000; border-radius: 12px; overflow: hidden; }
        video { width: 100%; max-height: 250px; display: block; }
        #active-subtitle { min-height: 70px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 20px; margin: 15px 0; line-height: 1.4; }
        #searchBar { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #3a3a3c; color: white; margin-bottom: 10px; box-sizing: border-box; }
        #transcript-list { height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; }
        .subtitle-item { padding: 12px; border-bottom: 1px solid #3a3a3c; cursor: pointer; font-size: 15px; color: #aeaeb2; }
        .subtitle-item.highlight { color: var(--primary); background: rgba(48,209,88,0.15); border-radius: 8px; font-weight: bold; }
        .hidden { display: none; }
        input[type="file"], input[type="text"], .start-btn { width: 100%; padding: 15px; margin-top: 10px; border-radius: 12px; border: none; box-sizing: border-box; font-size: 16px; }
        .auto-hint { font-size: 13px; color: var(--primary); margin-top: 8px; text-align: center; font-weight: 500; min-height: 1.2em; }
        label { font-size: 14px; color: #8e8e93; display: block; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-ui">
        <h2 style="text-align:center; margin-top:0;">å½±éŸ³åŒæ­¥å°æ™‚</h2>
        
        <label>1. é¸æ“‡å½±ç‰‡æˆ–éŸ³æª”</label>
        <input type="file" id="mediaFile" accept=".m4a, .mp3, .wav, .mp4, .mov, audio/*, video/*" onchange="triggerDetect()">
        
        <label>2. é¸æ“‡ SRT æˆ– TXT å­—å¹•æª”</label>
        <input type="file" id="srtFile" accept=".srt,.txt" onchange="triggerDetect()">
        
        <div id="timeHint" class="auto-hint">ç­‰å¾…é¸æ“‡æª”æ¡ˆ...</div>
        
        <label>3. èµ·å§‹æ™‚é–“ç¢ºèª</label>
        <input type="text" id="startTime" value="00:00:00" style="background:#3a3a3c; color:white; text-align:center; font-family:monospace;">
        
        <button class="start-btn" onclick="startPlayer()" style="background:var(--primary); color:black; font-weight:bold; margin-top:25px;">å•Ÿå‹•æ’­æ”¾æ¨¡å¼</button>
    </div>

    <div id="player-ui" class="hidden">
        <div id="wall-time">00:00:00</div>
        <div id="media-container"><video id="mainMedia" controls playsinline></video></div>
        <div id="active-subtitle">æº–å‚™æ’­æ”¾...</div>
        <input type="text" id="searchBar" placeholder="ğŸ” æœå°‹å…§å®¹..." oninput="filterSubtitles()">
        <div id="transcript-list"></div>
        <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#666; width:100%;">é‡æ–°è¼‰å…¥</button>
    </div>
</div>

<script>
    let transcript = [];
    let baseSeconds = 0;

    // --- æ ¸å¿ƒæ”¹ç‰ˆï¼šæ™ºèƒ½è§£ææ™‚é–“ (æ”¯æ´ 8 ä½èˆ‡ 10 ä½æ•¸å­—) ---
    function parseFileName(name) {
        if (!name) return null;
        
        // aiko æ ¼å¼: at 12.21.18
        const aikoMatch = name.match(/at\s(\d{2})\.(\d{2})\.(\d{2})/i);
        if (aikoMatch) return `${aikoMatch[1]}:${aikoMatch[2]}:${aikoMatch[3]}`;

        // Blackmagic æ ¼å¼: _(æœˆæ—¥)(æ™‚åˆ†ç§’æˆ–æ™‚åˆ†)_
        const bmMatch = name.match(/_(\d{4})(\d{4,6})_/);
        if (bmMatch) {
            const timePart = bmMatch[2];
            if (timePart.length === 6) {
                // 102753 -> 10:27:53
                return `${timePart.substring(0,2)}:${timePart.substring(2,4)}:${timePart.substring(4,6)}`;
            } else if (timePart.length === 4) {
                // 1027 -> 10:27:00
                return `${timePart.substring(0,2)}:${timePart.substring(2,4)}:00`;
            }
        }
        return null;
    }

    function triggerDetect() {
        const mediaFile = document.getElementById('mediaFile').files[0];
        const srtFile = document.getElementById('srtFile').files[0];
        const timeInput = document.getElementById('startTime');
        const hint = document.getElementById('timeHint');

        const srtTime = parseFileName(srtFile?.name);
        const mediaTime = parseFileName(mediaFile?.name);

        // æ”¹é€²é‚è¼¯ï¼šåªè¦æœ‰ä»»ä½•ä¸€å€‹æª”æ¡ˆæœ‰æ™‚é–“ï¼Œå°±é¡¯ç¤ºå‡ºä¾†
        if (srtTime) {
            timeInput.value = srtTime;
            hint.innerText = `âœ… å„ªå…ˆæ¡ç”¨å­—å¹•æª”æ™‚é–“: ${srtTime}`;
            hint.style.color = "var(--primary)";
        } else if (mediaTime) {
            timeInput.value = mediaTime;
            hint.innerText = `ğŸ’¡ æ¡ç”¨å½±éŸ³æª”æ™‚é–“: ${mediaTime}`;
            hint.style.color = "#ff9f0a";
        } else {
            // å¦‚æœé¸äº†æª”æ¡ˆä½†è§£æä¸åˆ°
            if (mediaFile || srtFile) {
                hint.innerText = "â“ æª”åæ ¼å¼ä¸ç¬¦ï¼Œè«‹æ‰‹å‹•ç¢ºèªèµ·å§‹æ™‚é–“";
                hint.style.color = "#8e8e93";
            } else {
                hint.innerText = "ç­‰å¾…é¸æ“‡æª”æ¡ˆ...";
            }
        }
    }

    function timeToSeconds(t) {
        const p = t.split(':');
        return parseInt(p[0]) * 3600 + parseInt(p[1]) * 60 + parseFloat(p[2] || 0);
    }

    function formatFullTime(s) {
        const h = Math.floor(s / 3600) % 24, m = Math.floor((s % 3600) / 60), sec = Math.floor(s % 60);
        return [h, m, sec].map(v => v.toString().padStart(2, '0')).join(':');
    }

    function filterSubtitles() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        document.querySelectorAll('.subtitle-item').forEach((el, idx) => {
            el.style.display = transcript[idx].text.toLowerCase().includes(query) ? "block" : "none";
        });
    }

    async function startPlayer() {
        const mediaInput = document.getElementById('mediaFile').files[0];
        const srtInput = document.getElementById('srtFile').files[0];
        if (!mediaInput || !srtInput) return alert("è«‹é¸å–å½±éŸ³èˆ‡ SRT/TXT æª”æ¡ˆ");

        baseSeconds = timeToSeconds(document.getElementById('startTime').value);
        const srtText = await srtInput.text();
        const regex = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n{2}|\n*$)/g;
        let match;
        const listContainer = document.getElementById('transcript-list');
        transcript = [];
        listContainer.innerHTML = '';

        while ((match = regex.exec(srtText)) !== null) {
            const start = timeToSeconds(match[2].replace(',', '.'));
            const text = match[4].replace(/\n/g, ' ');
            const wallTime = formatFullTime(baseSeconds + start);
            transcript.push({ start, end: timeToSeconds(match[3].replace(',', '.')), text });

            const div = document.createElement('div');
            div.className = 'subtitle-item';
            div.id = `sub-${transcript.length - 1}`;
            div.onclick = () => { document.getElementById('mainMedia').currentTime = start; document.getElementById('mainMedia').play(); };
            div.innerHTML = `<small style="color:var(--primary)">[${wallTime}]</small> ${text}`;
            listContainer.appendChild(div);
        }

        const mediaElement = document.getElementById('mainMedia');
        mediaElement.src = URL.createObjectURL(mediaInput);
        mediaElement.load();
        document.getElementById('setup-ui').classList.add('hidden');
        document.getElementById('player-ui').classList.remove('hidden');

        mediaElement.ontimeupdate = () => {
            const ct = mediaElement.currentTime;
            document.getElementById('wall-time').innerText = formatFullTime(baseSeconds + ct);
            const idx = transcript.findIndex(t => ct >= t.start && ct <= t.end);
            if (idx !== -1) {
                document.getElementById('active-subtitle').innerText = transcript[idx].text;
                document.querySelectorAll('.subtitle-item').forEach((el, i) => {
                    el.classList.toggle('highlight', i === idx);
                    if (i === idx) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            }
        };
    }
</script>
</body>
</html>
