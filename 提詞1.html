<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業語音提詞機</title>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        #controls {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #1e1e1e;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 100;
            border-bottom: 2px solid #333;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            font-size: 18px;
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #editBtn { background-color: #6c757d; }
        #startBtn { background-color: #007bff; }
        #startBtn.listening { background-color: #dc3545; }

        #timer {
            font-size: 32px;
            font-weight: bold;
            color: #ffeb3b;
            font-family: monospace;
            letter-spacing: 2px;
        }

        /* 讓狀態列更醒目，方便您觀察到底聽到了什麼字 */
        #status {
            width: 100%;
            margin-top: 10px;
            font-size: 16px;
            color: #00ffcc;
            text-align: center;
            font-weight: bold;
        }

        #main-content {
            margin-top: 130px;
            padding: 20px;
            padding-bottom: 80vh;
        }

        #editArea {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        textarea {
            width: 100%;
            height: 60vh;
            background-color: #2a2a2a;
            color: #ffffff;
            font-size: 24px;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 8px;
            box-sizing: border-box;
            line-height: 1.5;
            resize: vertical;
        }

        #prompterArea {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }

        .line {
            font-size: 42px;
            line-height: 1.6;
            margin-bottom: 40px;
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .line.active {
            opacity: 1;
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div class="btn-group">
            <button id="editBtn">切換到提詞機</button>
            <button id="startBtn" style="display: none;">啟動收音與防休眠</button>
        </div>
        <div id="timer">00:00</div>
        <div id="status">請在下方編輯您的演講稿。分段請按「Enter」換行。</div>
    </div>

    <div id="main-content">
        <div id="editArea">
            <textarea id="scriptInput">在這裡貼上您的演講稿。
每一行會變成提詞機的一個段落。
請使用 Enter 鍵來換行。
距離如果太遠，用平板麥克風會收音不良。
建議您戴上藍牙耳機來確保收音準確！
祝您錄影順利！</textarea>
        </div>
        <div id="prompterArea"></div>
    </div>

    <script>
        const editBtn = document.getElementById('editBtn');
        const startBtn = document.getElementById('startBtn');
        const statusText = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const editArea = document.getElementById('editArea');
        const prompterArea = document.getElementById('prompterArea');
        const scriptInput = document.getElementById('scriptInput');

        let isEditing = true;
        let isListening = false;
        let wakeLock = null;
        let linesDOM = [];
        let currentIndex = 0;

        let timerInterval = null;
        let secondsElapsed = 0;
        let hasStartedSpeaking = false;

        editBtn.addEventListener('click', () => {
            if (isEditing) {
                const text = scriptInput.value;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    alert("請輸入講稿內容！");
                    return;
                }

                prompterArea.innerHTML = '';
                lines.forEach((lineText, index) => {
                    const div = document.createElement('div');
                    div.className = 'line' + (index === 0 ? ' active' : '');
                    div.innerText = lineText;
                    prompterArea.appendChild(div);
                });

                linesDOM = document.querySelectorAll('.line');
                currentIndex = 0;

                editArea.style.display = 'none';
                prompterArea.style.display = 'block';
                startBtn.style.display = 'inline-block';
                editBtn.textContent = "返回編輯";
                statusText.textContent = "提詞機已準備就緒。點擊「啟動收音」以開始。";
                isEditing = false;
            } else {
                if (isListening) stopRecognition();
                editArea.style.display = 'block';
                prompterArea.style.display = 'none';
                startBtn.style.display = 'none';
                editBtn.textContent = "切換到提詞機";
                statusText.textContent = "編輯模式：可隨時修改您的講稿。";
                resetTimer();
                isEditing = true;
            }
        });

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {}
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        function updateTimerDisplay() {
            const minutes = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
            const seconds = String(secondsElapsed % 60).padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            stopTimer();
            secondsElapsed = 0;
            hasStartedSpeaking = false;
            updateTimerDisplay();
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (!SpeechRecognition) {
            alert("您的瀏覽器不支援語音辨識，請在 Android 平板上使用 Google Chrome 瀏覽器。");
        } else {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = true;
            // 【重要修改】改為 true，開啟即時文字辨識，反應更快速
            recognition.interimResults = true; 

            startBtn.addEventListener('click', () => {
                if (!isListening) {
                    recognition.start();
                    requestWakeLock();
                } else {
                    stopRecognition();
                }
            });

            recognition.onstart = () => {
                isListening = true;
                startBtn.textContent = "停止收音與計時";
                startBtn.classList.add('listening');
                statusText.textContent = "正在聆聽... (開口說話即自動開始計時)";
                linesDOM[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start();
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'not-allowed') {
                    stopRecognition();
                }
            };

            recognition.onresult = (event) => {
                if (!hasStartedSpeaking) {
                    hasStartedSpeaking = true;
                    startTimer();
                }

                // 將即時辨識的字串組合起來
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                transcript = transcript.trim();
                
                // 顯示目前聽到的文字，如果卡住，您可以看這裡確認平板到底聽到了什麼
                statusText.textContent = `聽到：${transcript}`;

                const cleanTranscript = transcript.replace(/[，。！？、\s]/g, '');
                
                // 如果講不到2個字，先不比對
                if (cleanTranscript.length < 2) return; 

                // 【重要修改】智慧跳行邏輯 (Lookahead)
                // 允許往下尋找 3 行，避免漏唸一行就卡死
                let matchedIndex = -1;
                let maxLookahead = Math.min(3, linesDOM.length - 1 - currentIndex);
                
                for (let offset = 1; offset <= maxLookahead; offset++) {
                    let checkIndex = currentIndex + offset;
                    const cleanNextLine = linesDOM[checkIndex].innerText.replace(/[，。！？、\s]/g, '');
                    
                    let matchFound = false;
                    // 【重要修改】只要連續 2 個字一樣就算過關
                    for (let i = 0; i <= cleanTranscript.length - 2; i++) {
                        const chunk = cleanTranscript.substr(i, 2);
                        if (cleanNextLine.includes(chunk)) {
                            matchFound = true;
                            break;
                        }
                    }
                    
                    if (matchFound) {
                        matchedIndex = checkIndex;
                        break; // 找到最接近的下一行就停止尋找
                    }
                }

                // 如果有找到匹配的行數，就執行滾動
                if (matchedIndex !== -1) {
                    linesDOM[currentIndex].classList.remove('active');
                    currentIndex = matchedIndex; // 直接跳到匹配的那一行
                    linesDOM[currentIndex].classList.add('active');
                    linesDOM[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };
        }

        function stopRecognition() {
            isListening = false;
            if (recognition) recognition.stop();
            startBtn.textContent = "啟動收音與防休眠";
            startBtn.classList.remove('listening');
            statusText.textContent = "收音與計時已暫停。";
            stopTimer();
            releaseWakeLock();
        }
    </script>
</body>
</html>
