<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DaVinci Final Fix</title>
    <style>
        :root { --primary: #007aff; --bg: #1a1a1b; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; padding: 20px; text-align: center; }
        .box { background: #262626; padding: 15px; border-radius: 12px; margin: 10px auto; max-width: 500px; }
        video { width: 100%; border-radius: 12px; background: #000; }
        input[type="text"] { background: #000; color: #34c759; border: 1px solid #444; padding: 8px; text-align: center; width: 120px; }
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: bold; cursor: pointer; color: white; }
        .list-item { background: #111; margin-top: 5px; padding: 10px; font-size: 12px; text-align: left; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>
    <h3>ğŸ¬ æ··åˆç´ ææœ€çµ‚ä¿®æ­£</h3>
    <input type="file" id="f" accept="video/*"><br><br>
    <video id="v" controls playsinline></video>

    <div class="box">
        <label>è©²æª”æ¡ˆ Start TC: </label>
        <input type="text" id="baseTC" value="00:00:00:00">
        <p style="font-size: 11px; color: #888;">(ä¸€èˆ¬æ‰‹æ©Ÿç”¨ 00:00:00:00 / BM Cam ç”¨ 20:08:06:00)</p>
        
        <div id="tc" style="font-family: monospace; font-size: 28px; color: #34c759; margin: 10px 0;">00:00:00:00</div>
        
        <button class="btn" style="background:var(--primary); width:45%" onclick="set('in')">è¨­å®š IN</button>
        <button class="btn" style="background:var(--primary); width:45%" onclick="set('out')">è¨­å®š OUT</button>
        <button class="btn" style="background:#34c759; width:92%; margin-top:10px;" onclick="add()">ï¼‹ åŠ å…¥æ¸…å–®</button>
    </div>

    <div id="clipLog" style="max-width:500px; margin:auto;"></div>
    <button class="btn" style="background:#f39c12; width:500px; margin-top:20px;" onclick="dl()">ğŸ’¾ ä¸‹è¼‰ä¿®æ­£ç‰ˆ EDL</button>

<script>
    let clips = [], cin = 0, cout = 0, fname = "";
    const V = document.getElementById('v'), FPS = 29.97;

    V.ontimeupdate = () => {
        document.getElementById('tc').innerText = calculateTC(V.currentTime, document.getElementById('baseTC').value);
    };

    document.getElementById('f').onchange = (e) => {
        if(e.target.files[0]) { 
            fname = e.target.files[0].name; 
            V.src = URL.createObjectURL(e.target.files[0]);
            // è‡ªå‹•åˆ‡æ›å»ºè­°å€¼
            document.getElementById('baseTC').value = fname.startsWith('A001') ? "20:08:06:00" : "00:00:00:00";
        }
    };

    function set(t) { if(t==='in') cin = V.currentTime; else cout = V.currentTime; }

    function add() {
        if(!fname) return;
        let b = document.getElementById('baseTC').value;
        let reel = fname.substring(0, 8).replace(/[^a-zA-Z0-9]/g, 'X').toUpperCase();
        clips.push({ n: fname, in: cin, out: cout, base: b, reel: reel });
        render();
    }

    function render() {
        document.getElementById('clipLog').innerHTML = clips.map((c, i) => `
            <div class="list-item">
                #${i+1} <b>${c.n}</b><br>
                Reel: ${c.reel} | StartTC: ${c.base}<br>
                Range: ${calculateTC(c.in, c.base)} -> ${calculateTC(c.out, c.base)}
            </div>
        `).join('');
    }

    function calculateTC(sec, baseStr) {
        let p = baseStr.split(':').map(Number);
        let baseFrames = ((p[0]*3600 + p[1]*60 + p[2])*30) + p[3];
        let total = baseFrames + Math.floor(sec * FPS + 0.00001);
        let f = total % 30, s = Math.floor(total/30)%60, m = Math.floor(total/1800)%60, h = Math.floor(total/108000);
        return [h, m, s, f].map(n=>String(n).padStart(2,'0')).join(':');
    }

    function dl() {
        if(clips.length === 0) return;
        let res = `TITLE: FINAL_REPAIR\nFCM: NON-DROP FRAME\n\n`, tp = 3600;
        clips.forEach((c, i) => {
            let si = calculateTC(c.in, c.base), so = calculateTC(c.out, c.base);
            let ri = calculateTC(tp/30, "00:00:00:00"), ro = calculateTC((tp + (c.out-c.in)*30)/30, "00:00:00:00");
            res += `${String(i+1).padStart(3,'0')}  ${c.reel.padEnd(8)} V     C        ${si} ${so} ${ri} ${ro}  \n`;
            res += `* FROM CLIP NAME: ${c.n}\n\n`;
            tp += (c.out - c.in) * 30;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([res], {type:'text/plain'}));
        a.download = "Mixed_Final_Fix.edl";
        a.click();
    }
</script>
</body>
</html>