<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 影音校對播放器 (全格式支援)</title>
    <style>
        :root { --bg: #1c1c1e; --card: #2c2c2e; --primary: #30d158; --text: #ffffff; --accent: #0a84ff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); border-radius: 24px; padding: 25px; box-sizing: border-box; }
        #wall-time { font-family: "Menlo", monospace; font-size: 48px; text-align: center; color: var(--primary); margin: 10px 0; font-weight: bold; }
        #media-container { width: 100%; margin-top: 15px; background: #000; border-radius: 12px; overflow: hidden; }
        video, audio { width: 100%; display: block; }
        .list-container { height: 350px; overflow-y: auto; border-radius: 12px; background: rgba(0,0,0,0.2); margin-top: 15px; border: 1px solid #3a3a3c; }
        .subtitle-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #3a3a3c; font-size: 16px; cursor: pointer; }
        .highlight { background: rgba(48, 209, 88, 0.25) !important; color: #fff; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 12px; background: #3a3a3c; color: #fff; border: none; border-radius: 10px; font-size: 16px; text-align: center; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: #000; width: 100%; font-size: 17px; margin-top: 10px; }
        .btn-back { background: none; color: var(--accent); font-size: 16px; margin-bottom: 15px; padding: 0; text-align: left; }
        #edit-modal, #share-overlay { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 1000; }
        #edit-modal { background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        #share-overlay { background: var(--bg); padding: 20px; }
        textarea { width: 100%; height: 120px; background: #000; color: var(--primary); border: 1px solid var(--primary); border-radius: 10px; padding: 10px; font-size: 18px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container" id="setup-ui">
    <h3 style="text-align:center">影音校對工具</h3>
    <label style="font-size:12px; color:#aaa">選取影音 (M4A/MOV/MP4)</label>
    <input type="file" id="mediaFile" accept="video/*,audio/*,.m4a,.mov" onchange="autoDetect(this)" style="width:100%; margin:10px 0">
    <label style="font-size:12px; color:#aaa">選取字幕 (.srt)</label>
    <input type="file" id="srtFile" accept=".srt" onchange="autoDetect(this)" style="width:100%; margin:10px 0">
    
    <label style="font-size:12px; color:#aaa">真實起始時間 (HH:mm:ss)</label>
    <div class="input-group">
        <input type="text" id="startTime" value="00:00:00">
        <button class="btn" style="background:#444; color:#fff" onclick="resetTime()">重置</button>
    </div>
    <button class="btn btn-main" onclick="startApp()">開始播放</button>
</div>

<div class="container hidden" id="player-ui">
    <button class="btn-back" onclick="location.reload()">〈 返回更換檔案</button>
    <div id="wall-time">00:00:00</div>
    <div id="media-container"></div>
    <div class="list-container" id="list-container"></div>
    <button class="btn btn-main" style="background:var(--accent); color:#fff" onclick="openShare()">預覽並分享</button>
</div>

<div id="edit-modal">
    <div class="container">
        <h3 style="margin-top:0">修改內容</h3>
        <textarea id="edit-text"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn" style="flex:1; background:#444; color:#fff" onclick="closeEdit()">取消</button>
            <button class="btn" style="flex:1; background:var(--primary); color:#000" onclick="saveEdit()">儲存</button>
        </div>
    </div>
</div>

<div id="share-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center">
        <button onclick="closeShare()" style="background:none; border:none; color:var(--accent); font-size:18px">〈 返回</button>
        <b>分享總覽</b>
        <button onclick="doShare()" style="background:none; border:none; color:var(--accent); font-size:18px; font-weight:bold">發送</button>
    </div>
    <div id="preview-box" style="flex:1; background:#000; margin:15px 0; padding:15px; border-radius:12px; overflow-y:auto; white-space:pre-wrap; color:#ccc; border:1px solid #3a3a3c;"></div>
</div>

<script>
    let transcript = [], baseSeconds = 0, editIdx = -1;

    function autoDetect(input) {
        const name = input.files[0]?.name || "";
        // 格式 1: at 20.08.55
        let m1 = name.match(/at\s(\d{2})\.(\d{2})\.(\d{2})/i);
        if (m1) return document.getElementById('startTime').value = `${m1[1]}:${m1[2]}:${m1[3]}`;
        
        // 格式 2: A001_0201200855_C001 (抓中間 10 位數的最後 6 位)
        let m2 = name.match(/_(\d{4})(\d{2})(\d{2})(\d{2})_/);
        if (m2) return document.getElementById('startTime').value = `${m2[2]}:${m2[3]}:${m2[4]}`;
    }

    function resetTime() { document.getElementById('startTime').value = "00:00:00"; }

    async function startApp() {
        const mFile = document.getElementById('mediaFile').files[0];
        const sFile = document.getElementById('srtFile').files[0];
        if (!mFile || !sFile) return alert("請選取檔案");

        baseSeconds = hmsToSec(document.getElementById('startTime').value);
        const srtText = await sFile.text();
        
        const list = document.getElementById('list-container');
        list.innerHTML = ''; transcript = [];
        const reg = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n{2}|\n*$)/g;
        let m;
        while ((m = reg.exec(srtText)) !== null) {
            const start = hmsToSec(m[2].replace(',', '.'));
            const text = m[4].replace(/\n/g, ' ').trim();
            const wall = secToHms(baseSeconds + start);
            const idx = transcript.length;
            transcript.push({ start, end: hmsToSec(m[3].replace(',', '.')), text, wall });

            const div = document.createElement('div');
            div.className = 'subtitle-item';
            div.id = `sub-${idx}`;
            div.onclick = (e) => { if(e.target.type !== 'checkbox') { v.currentTime = start; v.play(); } };
            div.innerHTML = `<input type="checkbox" id="chk-${idx}"><span style="flex:1" id="t-${idx}"><small style="color:var(--primary)">[${wall}]</small> ${text}</span><span style="color:var(--accent);font-size:12px" onclick="event.stopPropagation();openEdit(${idx})">編輯</span>`;
            list.appendChild(div);
        }

        const v = document.createElement(mFile.name.toLowerCase().endsWith('.m4a') ? 'audio' : 'video');
        v.id = 'mainMedia'; v.controls = true; v.playsInline = true; v.src = URL.createObjectURL(mFile);
        document.getElementById('media-container').appendChild(v);
        document.getElementById('setup-ui').classList.add('hidden');
        document.getElementById('player-ui').classList.remove('hidden');

        v.ontimeupdate = () => {
            const ct = v.currentTime;
            document.getElementById('wall-time').innerText = secToHms(baseSeconds + ct);
            const idx = transcript.findIndex(t => ct >= t.start && ct <= t.end);
            if (idx !== -1) {
                document.querySelectorAll('.subtitle-item').forEach((el, i) => {
                    el.classList.toggle('highlight', i === idx);
                    if (i === idx && !v.paused) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            }
        };
    }

    function openEdit(i) { document.getElementById('mainMedia').pause(); editIdx = i; document.getElementById('edit-text').value = transcript[i].text; document.getElementById('edit-modal').style.display = 'flex'; }
    function closeEdit() { document.getElementById('edit-modal').style.display = 'none'; }
    function saveEdit() {
        const val = document.getElementById('edit-text').value;
        transcript[editIdx].text = val;
        document.getElementById(`t-${editIdx}`).innerHTML = `<small style="color:var(--primary)">[${transcript[editIdx].wall}]</small> ${val}`;
        closeEdit(); document.getElementById('mainMedia').play();
    }

    function openShare() {
        const sel = transcript.filter((_, i) => document.getElementById(`chk-${i}`).checked).map(t => `[${t.wall}] ${t.text}`);
        if (sel.length === 0) return alert("請勾選字幕");
        document.getElementById('preview-box').innerText = sel.join('\n');
        document.getElementById('share-overlay').style.display = 'flex';
    }
    function closeShare() { document.getElementById('share-overlay').style.display = 'none'; }
    async function doShare() {
        const txt = document.getElementById('preview-box').innerText;
        if (navigator.share) await navigator.share({ text: txt }).catch(() => {});
        else { navigator.clipboard.writeText(txt); alert("已複製"); }
    }

    function hmsToSec(t) { const p = t.split(':'); return parseInt(p[0])*3600 + parseInt(p[1])*60 + parseFloat(p[2]||0); }
    function secToHms(s) { const h = Math.floor(s/3600)%24, m = Math.floor((s%3600)/60), sec = Math.floor(s%60); return [h,m,sec].map(v=>v.toString().padStart(2,'0')).join(':'); }
</script>
</body>
</html>
