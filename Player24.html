<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å½±éŸ³æ ¡å°æ’­æ”¾å™¨ (ä¿®å¾©æ‰“é»è·³è½‰)</title>
    <style>
        :root { --bg: #1c1c1e; --card: #2c2c2e; --primary: #30d158; --text: #ffffff; --accent: #0a84ff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); border-radius: 24px; padding: 25px; box-sizing: border-box; }
        #wall-time { font-family: "Menlo", monospace; font-size: 48px; text-align: center; color: var(--primary); margin: 10px 0; font-weight: bold; }
        #media-container { width: 100%; margin-top: 15px; background: #000; border-radius: 12px; overflow: hidden; }
        video, audio { width: 100%; display: block; }
        
        /* æ‰“é»æ¨™ç±¤æ¨£å¼ */
        #marker-container::-webkit-scrollbar { display: none; }
        .marker-btn { background: #1c1c1e; color: var(--primary); padding: 8px 14px; border-radius: 10px; font-size: 14px; white-space: nowrap; border: 1px solid var(--primary); cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: "Menlo", monospace; }
        .marker-btn:active { background: rgba(48, 209, 88, 0.2); }

        .list-container { height: 350px; overflow-y: auto; border-radius: 12px; background: rgba(0,0,0,0.2); margin-top: 15px; border: 1px solid #3a3a3c; }
        .subtitle-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #3a3a3c; font-size: 16px; cursor: pointer; }
        .highlight { background: rgba(48, 209, 88, 0.25) !important; color: #fff; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 12px; background: #3a3a3c; color: #fff; border: none; border-radius: 10px; font-size: 16px; text-align: center; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: #000; width: 100%; font-size: 17px; margin-top: 10px; }
        .btn-back { background: none; color: var(--accent); font-size: 16px; margin-bottom: 15px; padding: 0; text-align: left; }
        #edit-modal, #share-overlay { position: fixed; inset: 0; display: none; flex-direction: column; z-index: 1000; }
        #edit-modal { background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        #share-overlay { background: var(--bg); padding: 20px; }
        textarea { width: 100%; height: 120px; background: #000; color: var(--primary); border: 1px solid var(--primary); border-radius: 10px; padding: 10px; font-size: 18px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container" id="setup-ui">
    <h3 style="text-align:center">å½±éŸ³æ ¡å°å·¥å…·</h3>
    <label style="font-size:12px; color:#aaa">1. é¸å–å½±éŸ³ (M4A/MOV/MP4)</label>
    <input type="file" id="mediaFile" accept="video/*,audio/*,.m4a,.mov" onchange="autoDetect(this)" style="width:100%; margin:10px 0">
    
    <label style="font-size:12px; color:#aaa">2. é¸å–å­—å¹• (.srt) [é¸å¡«]</label>
    <input type="file" id="srtFile" accept=".srt" onchange="autoDetect(this)" style="width:100%; margin:10px 0">
    
    <label style="font-size:12px; color:#aaa">3. é¸å–æ‰“é»æª” (.txt) [é¸å¡«]</label>
    <input type="file" id="markerFile" accept=".txt" onchange="autoDetect(this)" style="width:100%; margin:10px 0">
    
    <label style="font-size:12px; color:#aaa">çœŸå¯¦èµ·å§‹æ™‚é–“ (HH:mm:ss)</label>
    <div class="input-group">
        <input type="text" id="startTime" value="00:00:00">
        <button class="btn" style="background:#444; color:#fff" onclick="resetTime()">é‡ç½®</button>
    </div>
    <button class="btn btn-main" onclick="startApp()">é–‹å§‹æ’­æ”¾</button>
</div>

<div class="container hidden" id="player-ui">
    <button class="btn-back" onclick="location.reload()">ã€ˆ è¿”å›æ›´æ›æª”æ¡ˆ</button>
    <div id="wall-time">00:00:00</div>
    <div id="media-container"></div>
    
    <div id="marker-container" style="display:none; overflow-x:auto; gap:8px; margin-top:15px; padding-bottom:5px; -webkit-overflow-scrolling:touch; scrollbar-width:none;"></div>
    
    <div class="list-container" id="list-container"></div>
    <button class="btn btn-main" style="background:var(--accent); color:#fff" onclick="openShare()">é è¦½ä¸¦åˆ†äº«</button>
</div>

<div id="edit-modal">
    <div class="container">
        <h3 style="margin-top:0">ä¿®æ”¹å…§å®¹</h3>
        <textarea id="edit-text"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn" style="flex:1; background:#444; color:#fff" onclick="closeEdit()">å–æ¶ˆ</button>
            <button class="btn" style="flex:1; background:var(--primary); color:#000" onclick="saveEdit()">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="share-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center">
        <button onclick="closeShare()" style="background:none; border:none; color:var(--accent); font-size:18px">ã€ˆ è¿”å›</button>
        <b>åˆ†äº«ç¸½è¦½</b>
        <button onclick="doShare()" style="background:none; border:none; color:var(--accent); font-size:18px; font-weight:bold">ç™¼é€</button>
    </div>
    <div id="preview-box" style="flex:1; background:#000; margin:15px 0; padding:15px; border-radius:12px; overflow-y:auto; white-space:pre-wrap; color:#ccc; border:1px solid #3a3a3c;"></div>
</div>

<script>
    let transcript = [], baseSeconds = 0, editIdx = -1;

    function autoDetect(input) {
        const name = input.files[0]?.name || "";
        let m1 = name.match(/at\s(\d{2})\.(\d{2})\.(\d{2})/i);
        if (m1) return document.getElementById('startTime').value = `${m1[1]}:${m1[2]}:${m1[3]}`;
        
        let m2 = name.match(/_(\d{4})(\d{2})(\d{2})(\d{2})_/);
        if (m2) return document.getElementById('startTime').value = `${m2[2]}:${m2[3]}:${m2[4]}`;
    }

    function resetTime() { document.getElementById('startTime').value = "00:00:00"; }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ›´è°æ˜çš„æ™‚é–“è½‰æ›å™¨ï¼šè§£æ±º 00:10 è¢«èª¤èªç‚º 10 åˆ†é˜çš„å•é¡Œ
    function hmsToSec(t) {
        const p = t.split(':');
        if (p.length === 3) {
            return parseInt(p[0]) * 3600 + parseInt(p[1]) * 60 + parseFloat(p[2] || 0); // HH:mm:ss
        } else if (p.length === 2) {
            return parseInt(p[0]) * 60 + parseFloat(p[1] || 0); // mm:ss
        } else {
            return parseFloat(p[0] || 0); // ss
        }
    }

    function secToHms(s) { 
        const h = Math.floor(s/3600)%24, m = Math.floor((s%3600)/60), sec = Math.floor(s%60); 
        return [h,m,sec].map(v=>v.toString().padStart(2,'0')).join(':'); 
    }

    async function startApp() {
        const mFile = document.getElementById('mediaFile').files[0];
        const sFile = document.getElementById('srtFile').files[0];
        const mkFile = document.getElementById('markerFile').files[0];
        if (!mFile) return alert("è«‹è‡³å°‘é¸å–ä¸€å€‹å½±éŸ³æª”ï¼");

        baseSeconds = hmsToSec(document.getElementById('startTime').value);
        
        // ææ—©å»ºç«‹æ’­æ”¾å™¨å…ƒç´ ï¼Œè®“æ‰“é»æŒ‰éˆ•å¯ä»¥æº–ç¢ºç¶å®šè·³è½‰åŠŸèƒ½
        const v = document.createElement(mFile.name.toLowerCase().endsWith('.m4a') ? 'audio' : 'video');
        v.id = 'mainMedia'; v.controls = true; v.playsInline = true; v.src = URL.createObjectURL(mFile);
        document.getElementById('media-container').innerHTML = '';
        document.getElementById('media-container').appendChild(v);

        // --- è™•ç†æ‰“é»æª” (.txt) ---
        const markerContainer = document.getElementById('marker-container');
        markerContainer.innerHTML = '';
        if (mkFile) {
            const mkText = await mkFile.text();
            const lines = mkText.split('\n');
            const timeRegex = /(?:(?:(\d{1,2}):))?(\d{1,2}):(\d{2})(?:\.\d+)?/;
            let hasMarkers = false;
            let autoCount = 1;
            
            lines.forEach(line => {
                const match = line.match(timeRegex);
                if (match) {
                    let rawTime = match[0];
                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘è‹¥è¡Œå…§åªæœ‰æ•¸å­—ï¼Œè‡ªå‹•è£œä¸Šã€Œæ¨™è¨˜é» Xã€
                    let text = line.replace(rawTime, '').replace(/\[|\]/g, '').trim();
                    if (!text) {
                        text = `æ¨™è¨˜é» ${autoCount}`;
                        autoCount++;
                    }
                    
                    let tSec = hmsToSec(rawTime);
                    let relSec = tSec;
                    let wallStr = '';
                    
                    if (tSec >= baseSeconds && baseSeconds > 0) {
                        relSec = tSec - baseSeconds;
                        wallStr = secToHms(tSec);
                    } else {
                        wallStr = secToHms(baseSeconds + tSec);
                    }

                    const btn = document.createElement('button');
                    btn.className = 'marker-btn';
                    // ç›´æ¥æ“æ§å½±ç‰‡é€²åº¦
                    btn.onclick = () => { v.currentTime = relSec; v.play(); };
                    btn.innerHTML = `ğŸ“ [${wallStr}] ${text}`;
                    markerContainer.appendChild(btn);
                    hasMarkers = true;
                }
            });
            if (hasMarkers) markerContainer.style.display = 'flex';
        }

        // --- è™•ç†å­—å¹•æª” (.srt) ---
        const list = document.getElementById('list-container');
        list.innerHTML = ''; transcript = [];
        if (sFile) {
            const srtText = await sFile.text();
            const reg = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n{2}|\n*$)/g;
            let m;
            while ((m = reg.exec(srtText)) !== null) {
                const start = hmsToSec(m[2].replace(',', '.'));
                const text = m[4].replace(/\n/g, ' ').trim();
                const wall = secToHms(baseSeconds + start);
                const idx = transcript.length;
                transcript.push({ start, end: hmsToSec(m[3].replace(',', '.')), text, wall });

                const div = document.createElement('div');
                div.className = 'subtitle-item';
                div.id = `sub-${idx}`;
                div.onclick = (e) => { if(e.target.type !== 'checkbox') { v.currentTime = start; v.play(); } };
                div.innerHTML = `<input type="checkbox" id="chk-${idx}"><span style="flex:1" id="t-${idx}"><small style="color:var(--primary)">[${wall}]</small> ${text}</span><span style="color:var(--accent);font-size:12px" onclick="event.stopPropagation();openEdit(${idx})">ç·¨è¼¯</span>`;
                list.appendChild(div);
            }
        }

        document.getElementById('setup-ui').classList.add('hidden');
        document.getElementById('player-ui').classList.remove('hidden');

        v.ontimeupdate = () => {
            const ct = v.currentTime;
            document.getElementById('wall-time').innerText = secToHms(baseSeconds + ct);
            if(transcript.length > 0) {
                const idx = transcript.findIndex(t => ct >= t.start && ct <= t.end);
                if (idx !== -1) {
                    document.querySelectorAll('.subtitle-item').forEach((el, i) => {
                        el.classList.toggle('highlight', i === idx);
                        if (i === idx && !v.paused) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            }
        };
    }

    // --- ç·¨è¼¯èˆ‡åˆ†äº«åŠŸèƒ½ ---
    function openEdit(i) { document.getElementById('mainMedia').pause(); editIdx = i; document.getElementById('edit-text').value = transcript[i].text; document.getElementById('edit-modal').style.display = 'flex'; }
    function closeEdit() { document.getElementById('edit-modal').style.display = 'none'; }
    function saveEdit() {
        const val = document.getElementById('edit-text').value;
        transcript[editIdx].text = val;
        document.getElementById(`t-${editIdx}`).innerHTML = `<small style="color:var(--primary)">[${transcript[editIdx].wall}]</small> ${val}`;
        closeEdit(); document.getElementById('mainMedia').play();
    }

    function openShare() {
        const sel = transcript.filter((_, i) => document.getElementById(`chk-${i}`).checked).map(t => `[${t.wall}] ${t.text}`);
        if (sel.length === 0) return alert("è«‹å‹¾é¸å­—å¹•");
        document.getElementById('preview-box').innerText = sel.join('\n');
        document.getElementById('share-overlay').style.display = 'flex';
    }
    function closeShare() { document.getElementById('share-overlay').style.display = 'none'; }
    async function doShare() {
        const txt = document.getElementById('preview-box').innerText;
        if (navigator.share) await navigator.share({ text: txt }).catch(() => {});
        else { navigator.clipboard.writeText(txt); alert("å·²è¤‡è£½"); }
    }
</script>
</body>
</html>
